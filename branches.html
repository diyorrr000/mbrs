<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filiallar - MBRS</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .branch-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .branch-stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .branch-stat-card h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #555;
        }
        
        .branch-stat-card .number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .active-branch {
            color: #27ae60;
        }
        
        .inactive-branch {
            color: #e74c3c;
        }
        
        .branch-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .branch-card:hover {
            transform: translateY(-5px);
        }
        
        .branch-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .branch-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .branch-body {
            padding: 20px;
        }
        
        .branch-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-item i {
            color: #3498db;
            width: 20px;
        }
        
        .branch-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .branches-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .branches-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="dashboard">
    <!-- SIDEBAR (dashboard.html dagi bilan bir xil) -->
    <aside class="sidebar">
        <div class="logo">
            <i class="fas fa-chart-network"></i>
            <h2>MBRS</h2>
        </div>
        <nav class="sidebar-nav">
            <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="branches.html" class="active"><i class="fas fa-sitemap"></i> Filiallar</a>
            <a href="reports.html"><i class="fas fa-file-alt"></i> Hisobotlar</a>
            <a href="analytics.html"><i class="fas fa-chart-line"></i> Tahlillar</a>
            <a href="settings.html"><i class="fas fa-cog"></i> Sozlamalar</a>
        </nav>
        <div class="user-info">
            <div class="user-avatar">
                <i class="fas fa-user-circle"></i>
            </div>
            <div class="user-details">
                <strong id="currentUser">Admin</strong>
                <small id="currentRole">Markaz Administrator</small>
                <button id="logoutBtn" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Chiqish</button>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <header class="content-header">
            <h1><i class="fas fa-sitemap"></i> Filiallar Boshqaruvi</h1>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openAddBranchModal()">
                    <i class="fas fa-plus"></i> Yangi Filial
                </button>
            </div>
        </header>

        <!-- Filiallar statistikasi -->
        <section class="branch-stats">
            <div class="branch-stat-card">
                <h3>Jami Filiallar</h3>
                <div class="number">5</div>
                <small>Faollar: 4, Nofaol: 1</small>
            </div>
            <div class="branch-stat-card">
                <h3>Oʻrtacha Daromad</h3>
                <div class="number">25.1M soʻm</div>
                <small>Oʻrtacha oylik</small>
            </div>
            <div class="branch-stat-card">
                <h3>Eng Samarali</h3>
                <div class="number active-branch">Toshkent</div>
                <small>75.4M soʻm daromad</small>
            </div>
            <div class="branch-stat-card">
                <h3>Oxirgi qoʻshilgan</h3>
                <div class="number">Namangan</div>
                <small>2022-09-05</small>
            </div>
        </section>

        <!-- Filiallar ro'yxati -->
        <div class="card">
            <div class="table-header">
                <h3><i class="fas fa-store"></i> Barcha Filiallar</h3>
                <div class="search-box">
                    <input type="text" id="branchSearch" placeholder="Filial nomi boʻyicha qidirish...">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            
            <div class="branches-grid" id="branchesList">
                <!-- Filial kartalari JS orqali to'ldiriladi -->
            </div>
        </div>

        <!-- Filial tafsilotlari modal -->
        <div class="modal" id="branchDetailsModal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('branchDetailsModal')">&times;</span>
                <h2 id="modalBranchName">Filial Nomi</h2>
                <div id="branchDetailsContent">
                    <!-- Tafsilotlar JS orqali to'ldiriladi -->
                </div>
            </div>
        </div>

        <!-- Yangi filial qo'shish modal -->
        <div class="modal" id="addBranchModal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('addBranchModal')">&times;</span>
                <h2><i class="fas fa-plus-circle"></i> Yangi Filial Qo'shish</h2>
                
                <form id="addBranchForm">
                    <div class="form-grid">
                        <div class="input-group">
                            <label for="branchName">Filial Nomi *</label>
                            <input type="text" id="branchName" required placeholder="Masalan: Fargʻona Filiali">
                        </div>
                        
                        <div class="input-group">
                            <label for="branchAddress">Manzil *</label>
                            <input type="text" id="branchAddress" required placeholder="Toʻliq manzil">
                        </div>
                        
                        <div class="input-group">
                            <label for="branchManager">Menejer Ismi *</label>
                            <input type="text" id="branchManager" required placeholder="Menejerning toʻliq ismi">
                        </div>
                        
                        <div class="input-group">
                            <label for="branchPhone">Telefon *</label>
                            <input type="tel" id="branchPhone" required placeholder="+998901234567">
                        </div>
                        
                        <div class="input-group">
                            <label for="branchEmail">Email</label>
                            <input type="email" id="branchEmail" placeholder="filial@biznes.uz">
                        </div>
                        
                        <div class="input-group">
                            <label for="branchStatus">Holati</label>
                            <select id="branchStatus">
                                <option value="active">Faol</option>
                                <option value="inactive">Nofaol</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="branchDescription">Qoʻshimcha maʼlumot</label>
                        <textarea id="branchDescription" rows="3" placeholder="Filial haqida qoʻshimcha maʼlumot..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addBranchModal')">
                            Bekor qilish
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Saqlash
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script src="js/data.js"></script>
    <script>
        // Dashboard sahifasida ishlatiladigan funksiyalar
        document.addEventListener('DOMContentLoaded', function() {
            loadBranches();
            setupEventListeners();
        });
        
        function loadBranches() {
            const branchesList = document.getElementById('branchesList');
            const dataManager = window.dataManager || new DataManager();
            const branches = dataManager.getBranches();
            const transactions = dataManager.getTransactions();
            
            branchesList.innerHTML = '';
            
            branches.forEach(branch => {
                // Filial statistikasini hisoblash
                const branchTransactions = transactions.filter(t => t.branchId === branch.id);
                const income = branchTransactions.filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                const expense = branchTransactions.filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                const profit = income - expense;
                
                const branchCard = document.createElement('div');
                branchCard.className = 'branch-card';
                branchCard.innerHTML = `
                    <div class="branch-header">
                        <h3>${branch.name}</h3>
                        <span class="branch-status ${branch.status === 'active' ? 'status-active' : 'status-inactive'}">
                            ${branch.status === 'active' ? 'Faol' : 'Nofaol'}
                        </span>
                    </div>
                    
                    <div class="branch-body">
                        <div class="branch-info">
                            <div class="info-item">
                                <i class="fas fa-user"></i>
                                <span>${branch.manager}</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-phone"></i>
                                <span>${branch.phone}</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${branch.address}</span>
                            </div>
                        </div>
                        
                        <div class="branch-stats-mini">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <div>
                                    <small>Daromad</small>
                                    <div style="color: #27ae60; font-weight: 600;">
                                        ${income.toLocaleString('uz-UZ')} soʻm
                                    </div>
                                </div>
                                <div>
                                    <small>Foyda</small>
                                    <div style="color: #3498db; font-weight: 600;">
                                        ${profit.toLocaleString('uz-UZ')} soʻm
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="branch-actions">
                            <button class="btn btn-sm btn-outline" onclick="viewBranchDetails(${branch.id})">
                                <i class="fas fa-eye"></i> Koʻrish
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="editBranch(${branch.id})">
                                <i class="fas fa-edit"></i> Tahrirlash
                            </button>
                        </div>
                    </div>
                `;
                
                branchesList.appendChild(branchCard);
            });
        }
        
        function setupEventListeners() {
            // Qidiruv funksiyasi
            const searchInput = document.getElementById('branchSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const branchCards = document.querySelectorAll('.branch-card');
                    
                    branchCards.forEach(card => {
                        const branchName = card.querySelector('h3').textContent.toLowerCase();
                        if (branchName.includes(searchTerm)) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            }
            
            // Formani yuborish
            const addBranchForm = document.getElementById('addBranchForm');
            if (addBranchForm) {
                addBranchForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const newBranch = {
                        name: document.getElementById('branchName').value,
                        address: document.getElementById('branchAddress').value,
                        manager: document.getElementById('branchManager').value,
                        phone: document.getElementById('branchPhone').value,
                        email: document.getElementById('branchEmail').value,
                        status: document.getElementById('branchStatus').value,
                        description: document.getElementById('branchDescription').value
                    };
                    
                    // Ma'lumotlar bazasiga qo'shish
                    const dataManager = window.dataManager || new DataManager();
                    dataManager.addBranch(newBranch);
                    
                    alert('Yangi filial muvaffaqiyatli qoʻshildi!');
                    closeModal('addBranchModal');
                    loadBranches();
                    
                    // Formani tozalash
                    this.reset();
                });
            }
        }
        
        function openAddBranchModal() {
            document.getElementById('addBranchModal').style.display = 'flex';
        }
        
        function viewBranchDetails(branchId) {
            const dataManager = window.dataManager || new DataManager();
            const branch = dataManager.getBranches().find(b => b.id === branchId);
            const transactions = dataManager.getTransactions(branchId);
            
            if (!branch) return;
            
            // Hisoblash
            const income = transactions.filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            const profit = income - expense;
            const transactionCount = transactions.length;
            
            document.getElementById('modalBranchName').textContent = branch.name;
            
            document.getElementById('branchDetailsContent').innerHTML = `
                <div class="branch-details">
                    <div class="details-grid">
                        <div class="detail-item">
                            <strong>Menejer:</strong> ${branch.manager}
                        </div>
                        <div class="detail-item">
                            <strong>Manzil:</strong> ${branch.address}
                        </div>
                        <div class="detail-item">
                            <strong>Telefon:</strong> ${branch.phone}
                        </div>
                        <div class="detail-item">
                            <strong>Email:</strong> ${branch.email || 'Mavjud emas'}
                        </div>
                        <div class="detail-item">
                            <strong>Holati:</strong> 
                            <span class="${branch.status === 'active' ? 'status-active' : 'status-inactive'}" style="padding: 3px 10px; border-radius: 4px;">
                                ${branch.status === 'active' ? 'Faol' : 'Nofaol'}
                            </span>
                        </div>
                        <div class="detail-item">
                            <strong>Ochilgan sana:</strong> ${branch.established}
                        </div>
                    </div>
                    
                    <div class="branch-performance" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                        <h3><i class="fas fa-chart-line"></i> Faoliyat Ko'rsatkichlari</h3>
                        <div class="performance-stats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 15px;">
                            <div class="perf-stat" style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <div style="color: #27ae60; font-size: 1.5rem; font-weight: 700;">
                                    ${income.toLocaleString('uz-UZ')}
                                </div>
                                <small>Jami Daromad</small>
                            </div>
                            <div class="perf-stat" style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <div style="color: #e74c3c; font-size: 1.5rem; font-weight: 700;">
                                    ${expense.toLocaleString('uz-UZ')}
                                </div>
                                <small>Jami Xarajat</small>
                            </div>
                            <div class="perf-stat" style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <div style="color: #3498db; font-size: 1.5rem; font-weight: 700;">
                                    ${profit.toLocaleString('uz-UZ')}
                                </div>
                                <small>Jami Foyda</small>
                            </div>
                            <div class="perf-stat" style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700;">
                                    ${transactionCount}
                                </div>
                                <small>Tranzaksiyalar</small>
                            </div>
                        </div>
                    </div>
                    
                    ${branch.description ? `
                    <div class="branch-description" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <strong><i class="fas fa-info-circle"></i> Qo'shimcha ma'lumot:</strong>
                        <p style="margin-top: 10px;">${branch.description}</p>
                    </div>
                    ` : ''}
                    
                    <div class="modal-actions" style="margin-top: 30px; text-align: right;">
                        <button class="btn btn-primary" onclick="generateBranchReport(${branchId})">
                            <i class="fas fa-file-pdf"></i> Hisobot yaratish
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('branchDetailsModal').style.display = 'flex';
        }
        
        function editBranch(branchId) {
            alert('Tahrirlash funksiyasi (backend bilan ishlaydi). Bu yerda filial ma\'lumotlarini tahrirlash mumkin.');
        }
        
        function generateBranchReport(branchId) {
            alert(`Filial hisoboti yaratildi (ID: ${branchId}). PDF formatida saqlash mumkin.`);
        }
        
        // Modalni yopish funksiyasi
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Global funksiyalar
        window.openAddBranchModal = openAddBranchModal;
        window.viewBranchDetails = viewBranchDetails;
        window.editBranch = editBranch;
        window.generateBranchReport = generateBranchReport;
        window.closeModal = closeModal;
    </script>
</body>
</html>